# Компонент HLK-LD2402 ESPHome

Этот компонент объединяет радарный модуль HLK-LD2402 24 ГГц с ESPHome, обеспечивая обнаружение присутствия, микродвижение и измерение расстояния. Он всесторонне интегрирует все документированные функции.

Приведенный здесь код сгенерирован искусственным интеллектом! Мне потребовалось время, чтобы убедиться, что все это работает, но он может делать очень глупые вещи, о которых я не знаю. Тем не менее, если бы не поддержка искусственного интеллекта, этот модуль мог бы вообще не существовать.

Приведенный здесь код был разработан для модуля, работающего под управлением прошивки версии v3.5.5. Во время разработки возникали различные несоответствия и недокументированные функции, которые были устранены или встроены в этот компонент. Мое предполагаемое приложение использует ESP8266, поэтому приведенный здесь код написан с учетом этого, если вы используете другую плату, не забудьте внести соответствующие изменения. 

Версия G - то есть HLK-LD2402G включает в себя LD, который позволяет этому модулю работать от напряжения 5 В. Другие версии должны иметь напряжение 3,3 В. Документация для этого модуля, похоже, отстает от фактической реализации и даже тогда доступна только на китайском языке, хотя в этом репозитории вы можете обратиться к ней, если захотите. Hilink сделала доступными различные загрузки по теме [здесь](https://www.hlktech.com/en/Goods-248.html#datum). Я отмечаю, что их копия sscom5.13.1 была помечена virus total, и песочница обнаружила довольно жуткое поведение, и это в любом случае излишне, так что просто избегайте этого. Специфичный для LD2402G инструмент был чистым, но всегда запускайте его против virus total или используйте в изолированной среде. 

Этот модуль - единственный, который я видел, который реализует своего рода регулируемую калибровку, при которой пороговые значения настраиваются на базовую чувствительность. Проверка помех от источника питания также довольно крутая. Он действительно горячий на ощупь. 

Для этого мы будем использовать контакты ESP32 TX / RX, так что не забудьте отключить ведение журнала uart!
   ```yaml
logger:
  baud_rate: 0
   ```

## Table of Contents
- [Обзор модуля](#module-overview)
- [Особенности интеграции ESPHome](#esphome-integration-features)
- [Установка](#installation)
- [Параметры конфигурации](#configuration-options)
  - [Полная Конфигурация](#complete-configuration)
  - [Минимальная конфигурация](#minimal-configuration)
- [Доступные датчики](#available-sensors)
- [Функции управления](#control-functions)
- [Руководство по калибровке](#calibration-guide)
- [Управление пороговыми значениями](#threshold-management)
- [Инженерный режим](#engineering-mode)
- [Общие проблемы и решения](#common-issues--solutions)
- [Техническая справка](#technical-reference)

## Обзор модуля

HLK-LD2402 - это радарный датчик миллиметрового диапазона 24 ГГц от Hi-Link, который может обнаруживать присутствие человека, движение и микродвижения. Это особенно полезно для приложений Интернета вещей, где требуется точное определение присутствия даже при неподвижном состоянии объектов.

### Основные характеристики из технической документации

- ** Возможности обнаружения**:
  - Обнаружение движения на расстоянии до 10 м
  - Обнаружение микродвижения на расстоянии до 6 м
  - Обнаружение статического присутствия человека на расстоянии до 5 м
  - Угол обнаружения по горизонтали ± 60 °

- ** Технические характеристики**:
  - Диапазон частот ISM 24 ГГц (24,0-24,25 ГГц)
  - Точность измерения расстояния: ± 0,15 м
  - Источник питания: 3,0-3,6 В (стандартное 3,3 В) или 4,5-5,5 В с LDO
  - Средний потребляемый ток: 50 мА
  - Связь: UART (скорость передачи 115200 бод, 8N1)
  - Рабочая температура: от -40 ° C до 85 ° C
  - Компактный размер: 20 мм × 20 мм

# Функции интеграции # ESPHome

- ** Основные датчики**:
  - Датчик расстояния (см) - измеряет расстояние до обнаруженного человека
  - Двоичный датчик присутствия - обнаруживает присутствие человека (движение + неподвижность)
  - Двоичный датчик микродвижения - обнаруживает едва заметные движения, такие как дыхание
  - Двоичный датчик помех от источника питания - Контролирует качество электропитания

- ** Диагностические датчики**:
  - Датчики энергетического вентиля (15 вентилей) - Показывают уровень исходного сигнала на разных расстояниях
  - Датчики порога движения - Отображают настроенную чувствительность к движению с помощью параметра расстояния
  - Датчики порога микродвижения - Отображают настроенную чувствительность к микродвижению
  - Датчик хода калибровки - Показывает процент завершения калибровки
  - Текстовый датчик версии прошивки - Отображает версию прошивки устройства
  - Текстовый датчик режима работы - Показывает текущий режим работы (обычный / инженерный / конфиг)

- ** Функции управления**:
  - Калибровка - Автоматически оптимизирует пороговые значения обнаружения
  - Функция автоматического усиления - Настраивает усиление сигнала в зависимости от окружающей среды
  - Сохранение конфигурации - Сохраняет настройки во флэш-памяти модуля радара
  - Инженерный режим - Включает расширенное тестирование и мониторинг необработанного сигнала
  - Управление пороговым значением элемента управления - Точная настройка чувствительности обнаружения для каждого элемента управления расстоянием
  - Пользовательская калибровка - Создание пороговых значений с регулируемыми множителями чувствительности
  - Сброс настроек - Восстановление заводской конфигурации по умолчанию

- ** Режимы работы**:
  - Обычный режим - Стандартное обнаружение присутствия
  - Инженерный режим - Подробный анализ сигнала и пороговых значений
  - Режим конфигурации - Настройка параметров и калибровка

- ** Параметры конфигурации**:
  - Максимальное расстояние обнаружения
  - Время ожидания исчезновения цели
  - Индивидуальная настройка порога для всех 15 элементов управления расстоянием
  - Умножители чувствительности калибровки

## Установка

1. Добавьте это хранилище к вашим внешним компонентам ESPHome:
   ```yaml
   external_components:
     - source:
         type: git
         url: https://github.com/mouldybread/hlk_ld2402_esphome
       refresh: 0ms
   ```

2. Настройте компонент с помощью одного из приведенных ниже примеров YAML-файлов
   - Используйте `hlk_ld2402_complete.yaml` для настройки и калибровки
   - Используйте `hlk_ld2402_minimal.yaml` для повседневной работы после калибровки

3. Flash your ESP device with the chosen configuration

## Параметры конфигурации

### Полная конфигурация
Полная конфигурация (`hlk_ld2402_complete.yaml`) включает все доступные датчики, диагностические инструменты и элементы управления калибровкой. Это рекомендуется, когда:
- Первая настройка устройства
- Калибровка радара
- Точная настройка порогов обнаружения
- Устранение неполадок с обнаружением

### Минимальная настройка
После того, как ваше устройство будет должным образом откалибровано и настроено, переключитесь на минимальную конфигурацию (`hlk_ld2402_minimal.yaml`), которая включает только:
- Датчик расстояния
- Обнаружение присутствия
- Обнаружение микродвижения
- Обнаружение помех от источника питания
- Кнопка базовой калибровки
- Кнопка сохранения конфигурации

Эта упрощенная конфигурация сокращает использование памяти, повышает быстродействие и обеспечивает более чистый пользовательский интерфейс для повседневного использования.

## Доступные датчики

### Бинарные датчики

| Датчик | Описание | Использование |
|--------|-------------|-------|
| Присутствие | Обнаруживает присутствие человека (движение + статическое присутствие) | Основной датчик обнаружения присутствия |
| Микродвижение | Обнаруживает едва заметные движения (дыхание, набор текста) | Полезно для обнаружения неподвижных людей |
| Помехи от источника питания | Контролирует качество источника питания | Помогает диагностировать проблемы с обнаружением |

### Датчик расстояния

Измеряет расстояние до обнаруженного человека в сантиметрах (точность: ± 15 см). Дальность зависит от режима обнаружения:
- Обнаружение движения: 0-10 м
- Обнаружение микродвижения: 0-6 м 
- Обнаружение статического присутствия: 0-5 м

### Диагностические датчики

Доступны в полной конфигурации для устранения неполадок:

#### Датчики энергетических вентилей
Отображают уровень исходного сигнала на разных расстояниях, что полезно для:
- Визуализации дальности обнаружения и чувствительности
- Определение источников ложного обнаружения
- Устранение неполадок с обнаружением

#### Датчики порога
Отображение настроенных пороговых значений для каждого элемента управления:
- Пороги движения: управляет чувствительностью при больших перемещениях
- Пороги микродвижения: управляет чувствительностью при незначительных перемещениях

### Текстовые датчики

| Датчик | Описание | Использование /
|--------|-------------|-------|
| Версия встроенного ПО | Отображает встроенное ПО модуля радара | Полезно для устранения неполадок совместимости |
| Режим работы | Показывает текущий режим (обычный / Инженерный / Конфигурационный) | Указывает рабочее состояние радара |

## Функции управления
- Пороговые значения микродвижения: 35-50 дБ (ниже = более чувствительны)
- Для вентилей, удаленных от датчика, обычно требуются более низкие пороговые значения

## Инженерный режим

Инженерный режим обеспечивает прямой доступ к необработанным данным радара для расширенного устранения неполадок и калибровки.

### Использование инженерного режима
1. Нажмите "Установить инженерный режим"
2. Просмотрите значения энергии в режиме реального времени для каждого параметра расстояния.
3. Показания показывают уровень отраженного сигнала в дБ
4. Более высокие значения указывают на более сильные отражения (потенциальное обнаружение)
5. Вернитесь в нормальный режим, нажав "Установить нормальный режим"

### Интерпретация значений энергии
- Фоновый шум: обычно 10-25 дБ
- Присутствие человека: обычно вызывает превышение фона на 10-30 дБ
- Значения, постоянно превышающие пороговое значение срабатывания триггера
- Сравните значения энергии с пороговыми значениями, чтобы понять поведение при обнаружении

## Распространенные проблемы и решения

### Нет обнаружения / низкая дальность действия
- ** Проверьте источник питания ** - Модулю требуется чистое питание 3,3 В или 5 В
- ** Запустите автоматическое усиление ** - Отрегулируйте усиление в соответствии с вашими условиями
- ** Нижние пороги ** для поврежденных ворот
- ** Проверьте высоту установки ** - Должна составлять 1,5-2,0 м для настенного монтажа, 2,7-3,0 м для потолочного

### Ложные обнаружения
- ** Выполните повторную калибровку ** при пустом помещении
- ** Увеличьте пороговые значения ** для проблемных ворот
- ** Проверьте, нет ли движущихся объектов ** (занавесок, растений возле вентиляционных отверстий)
- ** Проверьте наличие электронных помех ** - Держитесь подальше от маршрутизаторов Wi-Fi, двигателей

### Обнаружение прекращается после движения
- ** Проверьте настройку тайм-аута ** - Увеличьте, если обнаружение падает слишком быстро
- ** Проверьте пороговые значения микродвижения ** - Понизьте для лучшего обнаружения статических помех

### Предупреждения о помехах от источника питания
- ** Используйте чистый источник питания ** - Линейный источник питания или LDO хорошего качества
- ** Добавьте конденсаторы ** к источнику питания (рекомендуется 100 мкФ + 0,1 мкФ)
- ** Отделите источник питания ** от шумящих компонентов (двигателей, реле)

### Конфигурация не экономит
- ** Убедитесь, что сохранение конфигурации завершено ** успешно
- ** Проверьте журналы на наличие сообщений об ошибках**
- ** Перезагрузите модуль **, если он сохраняется

## Техническая справка

### Контрольное Расстояние до ворот

| Индекс ворот | Диапазон расстояний |
|------------|---------------|
| 0 | 0.0m - 0.7m |
| 1 | 0.7m - 1.4m |
| 2 | 1.4m - 2.1m |
| 3 | 2.1m - 2.8m |
| 4 | 2.8m - 3.5m |
| 5 | 3.5m - 4.2m |
| 6 | 4.2m - 4.9m |
| 7 | 4.9m - 5.6m |
| 8 | 5.6m - 6.3m |
| 9 | 6.3m - 7.0m |
| 10 | 7.0m - 7.7m |
| 11 | 7.7m - 8.4m |
| 12 | 8.4m - 9.1m |
| 13 | 9.1m - 9.8m |
| 14 | 9.8m - 10.5m |

### Дальность обнаружения при установке

** Конфигурация для настенного монтажа**:
- Обнаружение движения: до 10 м
- Обнаружение микродвижения: до 6 м
- Статическое присутствие: до 5 м
- Угол обнаружения: ± 60 °

** Конфигурация потолочного крепления**:
- Обнаружение движения: в радиусе до 5 м
- Обнаружение микродвижения: в радиусе до 4 м
- Статическое присутствие: в радиусе до 4 м
- Неподвижно лежащий человек: в радиусе до 3 м

### Требования к конфигурации

Для оптимальной производительности:
- Контакты UART TX / RX должны быть аппаратными UART, а не эмулироваться программным обеспечением
- Скорость передачи данных в бодах должна быть ровно 115200, 8N1
- Напряжение питания должно быть стабильным 3,3 В или 5 В при надлежащем регулировании
- Подождите 30-60 секунд после включения для инициализации модуля радара
- Установите надежно, чтобы избежать вибраций, вызывающих ложные срабатывания

## Лицензия

Этот компонент ESPHome выпущен под GNU GENERAL PUBLIC LICENSE версии 3.

## Кредиты

- Основан на технической документации Hi-Link HLK-LD2402
- Разработан для интеграции с ESPHome и Home Assistant
